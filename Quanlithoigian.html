<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Study Flow - Qu·∫£n L√Ω Th·ªùi Gian</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i React v√† Babel ƒë·ªÉ ch·∫°y JSX tr·ª±c ti·∫øp -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- T·∫£i th∆∞ vi·ªán Lucide Icons (N√≥ s·∫Ω t·ª± ƒë·ªông ƒë·∫∑t c√°c icons v√†o window.lucide) -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.min.js"></script>

    <!-- T·∫£i Firebase (S·ª≠ d·ª•ng module import an to√†n v√† g√°n v√†o window) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, addDoc, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // G√°n c√°c h√†m Firebase v√†o window ƒë·ªÉ script type="text/babel" c√≥ th·ªÉ truy c·∫≠p
        window.firebaseDependencies = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, query, orderBy, addDoc, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc, getDoc
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* NgƒÉn cu·ªôn body, ch·ªâ cho ph√©p main cu·ªôn */
        }
        /* Style cho Notification Box */
        #notification-box {
            min-width: 300px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, query, orderBy, addDoc, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc } = window.firebaseDependencies;
    
    // H√†m hi·ªÉn th·ªã th√¥ng b√°o thay cho alert/confirm
    const showNotification = (message, type = 'info') => {
        const notificationBox = document.getElementById('notification-box');
        if (!notificationBox) return;

        let bgColor = 'bg-blue-500';
        if (type === 'error') bgColor = 'bg-red-500';
        if (type === 'success') bgColor = 'bg-green-500';
        if (type === 'warning') bgColor = 'bg-orange-500';

        notificationBox.textContent = message;
        notificationBox.className = `p-3 rounded-lg text-white font-bold fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 transition-opacity duration-300 ${bgColor}`;
        notificationBox.style.opacity = 1;
        
        setTimeout(() => {
            notificationBox.style.opacity = 0;
        }, 5000);
    };

    // T·∫°o component proxy cho Lucide Icons
    const LucideIcon = ({ name, size = 24, className = '', fill = 'none' }) => {
        // ƒê·∫£m b·∫£o window.lucide ƒë√£ ƒë∆∞·ª£c t·∫£i
        const IconComponent = window.lucide && window.lucide[name]; 
        if (!IconComponent) return null;
        
        // T·∫°o m·ªôt component wrapper ƒë∆°n gi·∫£n cho icon
        return React.createElement(IconComponent, { size, className, fill });
    };

    // --- C·∫§U H√åNH FIREBASE (D√†nh cho b·∫£n tri·ªÉn khai ngo√†i Canvas) ---
    // H∆Ø·ªöNG D·∫™N: ƒê·ªîI TH√ÄNH C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N ƒê·ªÇ C√ì L∆ØU TR·ªÆ B·ªÄN V·ªÆNG
    // N·∫øu b·∫°n mu·ªën l∆∞u tr·ªØ d·ªØ li·ªáu, h√£y thay th·∫ø n·ªôi dung trong firebaseConfig
    const firebaseConfig = {
      // V√≠ d·ª•: apiKey: "...", authDomain: "...", projectId: "...",
    };
    
    // S·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh cho tri·ªÉn khai b√™n ngo√†i Canvas
    const appId = 'study-flow-v1'; 
    const initialAuthToken = ''; 
    const COLLECTION_PATH = `/artifacts/${appId}/users/`;

    // C·∫•u h√¨nh Pomodoro m·∫∑c ƒë·ªãnh
    const POMODORO_WORK_MINUTES = 25;
    const POMODORO_BREAK_MINUTES = 5;

    /**
     * H√†m t√≠nh ƒëi·ªÉm ∆∞u ti√™n (Urgency Score)
     * ƒêi·ªÉm c√†ng cao, c√¥ng vi·ªác c√†ng c·∫ßn l√†m ngay
     */
    const calculateUrgencyScore = (task) => {
        if (task.isCompleted) return -1;

        const today = Date.now();
        const deadline = new Date(task.deadline).getTime();
        const diffDays = (deadline - today) / (1000 * 60 * 60 * 24);

        let score = 0;

        // 1. ƒêi·ªÉm theo ƒë·ªô quan tr·ªçng (Importance Score)
        const priorityMap = { 'A': 3, 'B': 2, 'C': 1 };
        score += priorityMap[task.priority] * 5; // ƒêi·ªÉm n·ªÅn t·∫£ng

        // 2. ƒêi·ªÉm theo th·ªùi h·∫°n (Deadline Score)
        if (diffDays <= 0) {
            score += 50; // Qu√° h·∫°n (Overdue)
        } else if (diffDays <= 1) {
            score += 30; // R·∫•t g·∫•p (D∆∞·ªõi 24h)
        } else if (diffDays <= 3) {
            score += 15; // G·∫•p (D∆∞·ªõi 3 ng√†y)
        } else if (diffDays <= 7) {
            score += 5;  // C·∫ßn ch√∫ √Ω (D∆∞·ªõi 1 tu·∫ßn)
        }

        return score;
    };

    /**
     * H√†m ch√≠nh c·ªßa ·ª©ng d·ª•ng - Smart Study Flow
     */
    const App = () => {
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);
        const [isAuthReady, setIsAuthReady] = useState(false);
        const [tasks, setTasks] = useState([]);
        const [showForm, setShowForm] = useState(false);
        const [filter, setFilter] = useState('active'); // active, completed, all

        // State Pomodoro
        // { taskId, taskName, isWorking: true/false, timeRemaining: seconds, status: 'running'|'paused' }
        const [activePomodoro, setActivePomodoro] = useState(null);
        const [timerId, setTimerId] = useState(null); 

        // State cho Form th√™m/s·ª≠a task
        const [taskInput, setTaskInput] = useState({
            id: null,
            name: '',
            priority: 'B',
            deadline: '',
            estimatedTime: '60', // ƒê∆°n v·ªã ph√∫t
        });

        // 1. Kh·ªüi t·∫°o Firebase v√† X√°c th·ª±c (Auth)
        useEffect(() => {
            // Ki·ªÉm tra xem dependencies Firebase ƒë√£ ƒë∆∞·ª£c t·∫£i ch∆∞a
            if (!window.firebaseDependencies) {
                 showNotification("L·ªói: C√°c th∆∞ vi·ªán Firebase ch∆∞a ƒë∆∞·ª£c t·∫£i. ·ª®ng d·ª•ng s·∫Ω ch·∫°y ·ªü ch·∫ø ƒë·ªô t·∫°m th·ªùi.", 'error');
                 setUserId(crypto.randomUUID());
                 setIsAuthReady(true);
                 return;
            }

            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. D·ªØ li·ªáu s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u tr·ªØ b·ªÅn v·ªØng.");
                    // Thi·∫øt l·∫≠p user ID ng·∫´u nhi√™n khi kh√¥ng c√≥ config Firebase
                    setUserId(crypto.randomUUID());
                    setIsAuthReady(true);
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                const firestore = getFirestore(app);
                const authentication = getAuth(app);
                
                setDb(firestore);
                setAuth(authentication);

                const unsubscribe = onAuthStateChanged(authentication, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        if (initialAuthToken) {
                            signInWithCustomToken(authentication, initialAuthToken)
                                .catch(error => { console.error("L·ªói ƒëƒÉng nh·∫≠p custom token:", error); signInAnonymously(authentication); });
                        } else {
                            signInAnonymously(authentication);
                        }
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe();
            } catch (e) {
                console.error("L·ªói kh·ªüi t·∫°o Firebase:", e);
                // D√πng ID ng·∫´u nhi√™n n·∫øu Firebase l·ªói
                setUserId(crypto.randomUUID());
                setIsAuthReady(true);
            }
        }, []);

        // 2. L·∫Øng nghe Tasks t·ª´ Firestore
        useEffect(() => {
            if (!db || !userId) {
                // N·∫øu kh√¥ng c√≥ DB, kh·ªüi t·∫°o tasks r·ªóng
                if (isAuthReady && !db) setTasks([]); 
                return;
            }

            const userTaskCollectionPath = `${COLLECTION_PATH}${userId}/tasks`;
            const tasksRef = collection(db, userTaskCollectionPath);
            
            // Truy v·∫•n: s·∫Øp x·∫øp theo th·ªùi gian t·∫°o, ƒë·ªÉ d·ªÖ theo d√µi
            const q = query(tasksRef, orderBy('createdAt', 'asc')); 

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const fetchedTasks = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data,
                        // X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi Date t·ª´ Firestore Timestamp
                        deadline: data.deadline?.toDate ? data.deadline.toDate().toISOString().substring(0, 10) : data.deadline || '',
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null
                    };
                });
                setTasks(fetchedTasks);
            }, (error) => {
                console.error("L·ªói l·∫Øng nghe tasks Firestore:", error);
                showNotification("L·ªói t·∫£i d·ªØ li·ªáu t·ª´ Firestore. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.", 'error');
            });

            return () => unsubscribe();
        }, [db, userId, isAuthReady]);


        // 3. Logic B·ªô ƒë·∫øm Pomodoro (Timer Logic)
        useEffect(() => {
            if (activePomodoro && activePomodoro.timeRemaining > 0 && activePomodoro.status === 'running') {
                if (timerId) clearInterval(timerId);

                const newTimerId = setInterval(() => {
                    setActivePomodoro(prev => {
                        if (!prev || prev.timeRemaining <= 1) {
                            clearInterval(newTimerId);
                            
                            const nextIsWorking = !prev.isWorking;
                            const nextTime = nextIsWorking ? POMODORO_WORK_MINUTES * 60 : POMODORO_BREAK_MINUTES * 60;

                            const messageType = nextIsWorking ? "B·∫Øt ƒë·∫ßu l√†m vi·ªác" : "B·∫Øt ƒë·∫ßu ngh·ªâ gi·∫£i lao";
                            
                            // S·ª≠ d·ª•ng th√¥ng b√°o tr·ª±c quan
                            showNotification(`üîî H·∫øt gi·ªù! ${messageType}: ${prev.taskName}`, nextIsWorking ? 'info' : 'success');

                            return { 
                                ...prev, 
                                isWorking: nextIsWorking, 
                                timeRemaining: nextTime,
                                status: 'running' // T·ª± ƒë·ªông ch·∫°y chu k·ª≥ ti·∫øp theo
                            };
                        }
                        return { ...prev, timeRemaining: prev.timeRemaining - 1 };
                    });
                }, 1000);
                
                setTimerId(newTimerId);
                return () => clearInterval(newTimerId);
            } else if (activePomodoro && activePomodoro.status === 'paused' && timerId) {
                clearInterval(timerId);
                setTimerId(null);
            }
        }, [activePomodoro?.taskId, activePomodoro?.isWorking, activePomodoro?.timeRemaining, activePomodoro?.status, timerId]);


        // --- H√ÄM ƒêI·ªÄU KHI·ªÇN POMODORO ---

        const startPomodoro = (task) => {
            if (activePomodoro && activePomodoro.taskId !== task.id) {
                showNotification("Vui l√≤ng d·ª´ng Pomodoro hi·ªán t·∫°i tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu c√°i m·ªõi.", 'warning');
                return;
            }

            if (activePomodoro?.taskId === task.id) {
                // Ti·∫øp t·ª•c/B·∫Øt ƒë·∫ßu l·∫°i
                setActivePomodoro(prev => ({ 
                    ...prev, 
                    status: 'running',
                    timeRemaining: prev.timeRemaining || (POMODORO_WORK_MINUTES * 60) 
                }));
            } else {
                // B·∫Øt ƒë·∫ßu m·ªõi
                setActivePomodoro({
                    taskId: task.id,
                    taskName: task.name,
                    isWorking: true,
                    timeRemaining: POMODORO_WORK_MINUTES * 60,
                    status: 'running'
                });
            }
        };

        const pausePomodoro = () => {
            if (timerId) {
                setActivePomodoro(prev => ({ ...prev, status: 'paused' }));
            }
        };

        const resetPomodoro = () => {
            if (timerId) clearInterval(timerId);
            setTimerId(null);
            setActivePomodoro({
                taskId: activePomodoro.taskId,
                taskName: activePomodoro.taskName,
                isWorking: true,
                timeRemaining: POMODORO_WORK_MINUTES * 60,
                status: 'paused'
            });
            showNotification(`ƒê√£ thi·∫øt l·∫≠p l·∫°i Pomodoro cho c√¥ng vi·ªác: ${activePomodoro.taskName}`, 'info');
        };
        
        // --- H√ÄM X·ª¨ L√ù TASK ---

        const handleFormSubmit = async (e) => {
            e.preventDefault();
            if (!taskInput.name.trim() || !taskInput.deadline) {
                showNotification("Vui l√≤ng nh·∫≠p t√™n c√¥ng vi·ªác v√† h·∫°n ch√≥t.", 'warning');
                return;
            }

            try {
                const taskData = {
                    name: taskInput.name.trim(),
                    priority: taskInput.priority,
                    deadline: new Date(taskInput.deadline),
                    estimatedTime: parseInt(taskInput.estimatedTime, 10),
                    isCompleted: false,
                };

                // N·∫øu c√≥ DB, l∆∞u l√™n DB. N·∫øu kh√¥ng, ch·ªâ l∆∞u v√†o state (kh√¥ng b·ªÅn v·ªØng)
                if (db && userId) {
                     const userTaskCollectionPath = `${COLLECTION_PATH}${userId}/tasks`;
                    if (taskInput.id) {
                        await updateDoc(doc(db, userTaskCollectionPath, taskInput.id), taskData);
                        showNotification("C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng!", 'success');
                    } else {
                        await addDoc(collection(db, userTaskCollectionPath), {
                            ...taskData,
                            createdAt: serverTimestamp(),
                        });
                        showNotification("Th√™m c√¥ng vi·ªác th√†nh c√¥ng!", 'success');
                    }
                } else {
                    // X·ª≠ l√Ω mock data cho tr∆∞·ªùng h·ª£p kh√¥ng c√≥ Firebase
                    showNotification("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Task ƒë∆∞·ª£c th√™m t·∫°m th·ªùi.", 'warning');
                    setTasks(prevTasks => {
                        const newId = crypto.randomUUID();
                        if (taskInput.id) {
                            return prevTasks.map(t => t.id === taskInput.id ? {...t, ...taskData} : t);
                        } else {
                            return [...prevTasks, {...taskData, id: newId, createdAt: new Date()}];
                        }
                    });
                }
                resetForm();
            } catch (error) {
                console.error("L·ªói th√™m/c·∫≠p nh·∫≠t task:", error);
                showNotification("L·ªói khi th√™m/c·∫≠p nh·∫≠t c√¥ng vi·ªác.", 'error');
            }
        };

        const toggleTaskCompleted = async (taskId, currentStatus) => {
            if (!db || !userId) {
                 showNotification("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Tr·∫°ng th√°i ch·ªâ thay ƒë·ªïi t·∫°m th·ªùi.", 'warning');
                 setTasks(prevTasks => prevTasks.map(t => t.id === taskId ? {...t, isCompleted: !currentStatus} : t));
                 return;
            }
            const userTaskCollectionPath = `${COLLECTION_PATH}${userId}/tasks`;
            
            if (activePomodoro && activePomodoro.taskId === taskId) {
                if (timerId) clearInterval(timerId);
                setTimerId(null);
                setActivePomodoro(null);
                showNotification("ƒê√£ d·ª´ng Pomodoro ƒëang ch·∫°y.", 'info');
            }

            try {
                await updateDoc(doc(db, userTaskCollectionPath, taskId), {
                    isCompleted: !currentStatus,
                    completedAt: !currentStatus ? serverTimestamp() : null,
                });
                showNotification(`ƒê√£ ƒë√°nh d·∫•u l√† ${!currentStatus ? 'Ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh'}`, 'success');
            } catch (error) {
                console.error("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i task:", error);
                showNotification("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng vi·ªác.", 'error');
            }
        };

        const deleteTask = async (taskId) => {
            const isConfirmed = window.confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.");
            if (!isConfirmed) return;
            
            if (activePomodoro && activePomodoro.taskId === taskId) {
                if (timerId) clearInterval(timerId);
                setTimerId(null);
                setActivePomodoro(null);
            }

            if (!db || !userId) {
                 showNotification("Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Task ch·ªâ b·ªã x√≥a t·∫°m th·ªùi.", 'warning');
                 setTasks(prevTasks => prevTasks.filter(t => t.id !== taskId));
                 return;
            }
            const userTaskCollectionPath = `${COLLECTION_PATH}${userId}/tasks`;
            try {
                await deleteDoc(doc(db, userTaskCollectionPath, taskId));
                showNotification("ƒê√£ x√≥a c√¥ng vi·ªác th√†nh c√¥ng.", 'info');
            } catch (error) {
                console.error("L·ªói x√≥a task:", error);
                showNotification("L·ªói khi x√≥a c√¥ng vi·ªác.", 'error');
            }
        };

        const editTask = (task) => {
            setTaskInput({
                id: task.id,
                name: task.name,
                priority: task.priority,
                deadline: task.deadline,
                estimatedTime: String(task.estimatedTime),
            });
            setShowForm(true);
        };

        const resetForm = () => {
            setTaskInput({
                id: null,
                name: '',
                priority: 'B',
                deadline: '',
                estimatedTime: '60',
            });
            setShowForm(false);
        };

        // --- X·ª¨ L√ù HI·ªÇN TH·ªä V√Ä S·∫ÆP X·∫æP ---

        const getPriorityStyle = (priority) => {
            switch (priority) {
                case 'A': return 'text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300';
                case 'B': return 'text-yellow-600 bg-yellow-100 dark:bg-yellow-900 dark:text-yellow-300';
                case 'C': return 'text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-300';
                default: return 'text-gray-600 bg-gray-100 dark:bg-gray-700 dark:text-gray-300';
            }
        };

        const filteredAndSortedTasks = useMemo(() => {
            let filtered = tasks;

            if (filter === 'active') {
                filtered = tasks.filter(t => !t.isCompleted);
            } else if (filter === 'completed') {
                filtered = tasks.filter(t => t.isCompleted);
            }

            return filtered.sort((a, b) => {
                const scoreA = calculateUrgencyScore(a);
                const scoreB = calculateUrgencyScore(b);
                
                if (scoreA !== scoreB) {
                    return scoreB - scoreA;
                }
                
                if (new Date(a.deadline).getTime() !== new Date(b.deadline).getTime()) {
                    return new Date(a.deadline).getTime() - new Date(b.deadline).getTime();
                }
                
                return a.createdAt?.getTime() - b.createdAt?.getTime();
            });
        }, [tasks, filter]);

        const totalCompletedTime = tasks
            .filter(t => t.isCompleted)
            .reduce((sum, t) => sum + (t.estimatedTime || 0), 0);

        const formatTime = (minutes) => {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h} gi·ªù ${m} ph√∫t`;
        };

        const formatSecondsToMinutesAndSeconds = (totalSeconds) => {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };


        // --- UI COMPONENT: TASK CARD ---

        const TaskCard = ({ task }) => {
            const urgencyScore = calculateUrgencyScore(task);
            const isOverdue = urgencyScore >= 50 && !task.isCompleted;
            const deadlineDate = task.deadline ? new Date(task.deadline).toLocaleDateString('vi-VN') : 'N/A';
            
            const isPomodoroActive = activePomodoro && activePomodoro.taskId === task.id;
            const isPomodoroRunning = isPomodoroActive && activePomodoro.status === 'running';

            let barColor = 'bg-gray-300';
            if (urgencyScore > 50) barColor = 'bg-red-600';
            else if (urgencyScore > 30) barColor = 'bg-orange-500';
            else if (urgencyScore > 10) barColor = 'bg-indigo-400';
            else if (urgencyScore > 0) barColor = 'bg-blue-400';
            if (task.isCompleted) barColor = 'bg-green-500';

            const pomodoroTime = isPomodoroActive 
                ? formatSecondsToMinutesAndSeconds(activePomodoro.timeRemaining) 
                : formatSecondsToMinutesAndSeconds(POMODORO_WORK_MINUTES * 60);
            
            const pomodoroLabel = isPomodoroActive 
                ? (activePomodoro.isWorking ? 'L√†m vi·ªác' : 'Ngh·ªâ gi·∫£i lao')
                : 'S·∫µn s√†ng';

            return (
                <div className={`p-4 rounded-xl shadow-lg border-l-4 transition-all duration-300 ${task.isCompleted ? 'bg-green-50 dark:bg-gray-700 border-green-500 opacity-70' : 'bg-white dark:bg-gray-800 border-indigo-500'}`}>
                    
                    {/* Thanh ∆∞u ti√™n (Urgency Bar) */}
                    <div className={`h-1 rounded-full w-full mb-3 ${barColor} transition-all`}></div>

                    <div className="flex justify-between items-start flex-wrap">
                        <div className="flex-1 min-w-0 pr-4">
                            <h3 className={`text-lg font-semibold truncate ${task.isCompleted ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-900 dark:text-white'}`}>
                                {task.name}
                            </h3>
                            <div className="flex flex-wrap items-center mt-2 space-x-3 text-sm text-gray-600 dark:text-gray-400">
                                
                                <span className={`px-2 py-0.5 rounded-full font-medium ${getPriorityStyle(task.priority)}`}>
                                    Quan tr·ªçng: {task.priority}
                                </span>
                                
                                <span className="flex items-center">
                                    <LucideIcon name="Clock" size={14} className="mr-1 text-indigo-400" />
                                    ∆Ø·ªõc t√≠nh: {formatTime(task.estimatedTime)}
                                </span>
                                
                                <span className="flex items-center">
                                    <LucideIcon name="Calendar" size={14} className="mr-1 text-yellow-500" />
                                    H·∫°n ch√≥t: {deadlineDate}
                                </span>
                                
                                {isOverdue && (
                                    <span className="flex items-center text-red-600 font-bold ml-3 animate-pulse">
                                        <LucideIcon name="AlertTriangle" size={14} className="mr-1" />
                                        QU√Å H·∫†N!
                                    </span>
                                )}
                            </div>
                        </div>

                        {/* B·ªô ƒëi·ªÅu khi·ªÉn Pomodoro */}
                        {!task.isCompleted && (
                            <div className={`mt-3 md:mt-0 p-2 border rounded-xl flex items-center justify-center space-x-2 ${isPomodoroActive ? (activePomodoro.isWorking ? 'border-indigo-500 bg-indigo-50 dark:bg-gray-700' : 'border-green-500 bg-green-50 dark:bg-gray-700') : 'border-gray-300 dark:border-gray-700'}`}>
                                <span className={`font-mono text-xl font-bold ${isPomodoroActive ? (activePomodoro.isWorking ? 'text-indigo-600' : 'text-green-600') : 'text-gray-500 dark:text-gray-300'}`}>
                                    {pomodoroTime}
                                </span>
                                
                                <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${isPomodoroActive ? (activePomodoro.isWorking ? 'bg-indigo-200 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300' : 'bg-green-200 text-green-800 dark:bg-green-900 dark:text-green-300') : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300'}`}>
                                    {pomodoroLabel}
                                </span>
                                
                                {isPomodoroRunning ? (
                                    <button onClick={pausePomodoro} className="p-1 text-red-500 hover:bg-red-100 rounded-full transition" title="T·∫°m d·ª´ng">
                                        <LucideIcon name="Pause" size={18} />
                                    </button>
                                ) : (
                                    <button onClick={() => startPomodoro(task)} className="p-1 text-green-500 hover:bg-green-100 rounded-full transition" title="B·∫Øt ƒë·∫ßu">
                                        <LucideIcon name="Play" size={18} fill="currentColor" />
                                    </button>
                                )}
                                
                                {isPomodoroActive && (
                                    <button onClick={resetPomodoro} className="p-1 text-gray-500 hover:bg-gray-100 rounded-full transition" title="Thi·∫øt l·∫≠p l·∫°i">
                                        <LucideIcon name="RotateCcw" size={18} />
                                    </button>
                                )}
                            </div>
                        )}

                        <div className="flex space-x-2 ml-auto mt-3 md:mt-0 shrink-0">
                            {!task.isCompleted && (
                                <button 
                                    onClick={() => editTask(task)}
                                    className="p-2 text-indigo-600 hover:bg-indigo-100 dark:hover:bg-indigo-700 rounded-full transition"
                                    title="Ch·ªânh s·ª≠a"
                                    disabled={isPomodoroActive}
                                >
                                    <LucideIcon name="Edit" size={18} />
                                </button>
                            )}
                            <button 
                                onClick={() => toggleTaskCompleted(task.id, task.isCompleted)}
                                className={`p-2 rounded-full transition ${task.isCompleted ? 'text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600' : 'text-green-600 hover:bg-green-100 dark:hover:bg-green-700'}`}
                                title={task.isCompleted ? "Ch∆∞a ho√†n th√†nh" : "ƒê√£ ho√†n th√†nh"}
                                disabled={isPomodoroRunning}
                            >
                                <LucideIcon name="CheckCircle" size={18} fill={task.isCompleted ? 'currentColor' : 'none'} />
                            </button>
                            <button 
                                onClick={() => deleteTask(task.id)}
                                className="p-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-700 rounded-full transition"
                                title="X√≥a"
                                disabled={isPomodoroRunning}
                            >
                                <LucideIcon name="Trash2" size={18} />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- GIAO DI·ªÜN CH√çNH ---

        if (!isAuthReady) {
            return (
                <div className="flex items-center justify-center h-screen bg-gray-50 dark:bg-gray-900 text-gray-700 dark:text-gray-300">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                    <p className="ml-4">ƒêang t·∫£i ·ª©ng d·ª•ng v√† x√°c th·ª±c ng∆∞·ªùi d√πng...</p>
                </div>
            );
        }

        return (
            <div className="flex flex-col h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
                
                {/* V√πng Th√¥ng b√°o Pomodoro */}
                <div id="notification-box" className="p-3 rounded-lg text-white font-bold fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 transition-opacity duration-300 opacity-0 pointer-events-none"></div>

                {/* Header */}
                <header className="sticky top-0 z-10 p-4 bg-white dark:bg-gray-800 shadow-lg">
                    <div className="max-w-4xl mx-auto flex justify-between items-center">
                        <h1 className="text-2xl font-bold text-indigo-600 dark:text-indigo-400">
                            Smart Study Flow
                        </h1>
                        <button 
                            onClick={() => {
                                if (taskInput.id) resetForm(); 
                                setShowForm(!showForm);
                            }}
                            className={`p-3 rounded-full text-white transition duration-200 shadow-md flex items-center ${showForm ? 'bg-red-500 hover:bg-red-600 rotate-45' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                            title="Th√™m c√¥ng vi·ªác"
                        >
                            <LucideIcon name="Plus" size={24} className="transition duration-200" />
                        </button>
                    </div>
                </header>

                {/* Form Th√™m/S·ª≠a Task */}
                {showForm && (
                    <div className="p-4 bg-indigo-50 dark:bg-gray-700 shadow-inner">
                        <form onSubmit={handleFormSubmit} className="max-w-4xl mx-auto space-y-3">
                            <h2 className="text-xl font-semibold text-gray-800 dark:text-white mb-3">{taskInput.id ? 'S·ª≠a C√¥ng Vi·ªác' : 'Th√™m C√¥ng Vi·ªác M·ªõi'}</h2>
                            <input
                                type="text"
                                placeholder="T√™n c√¥ng vi·ªác (v√≠ d·ª•: L√†m b√†i t·∫≠p L√Ω ch∆∞∆°ng 4)"
                                value={taskInput.name}
                                onChange={(e) => setTaskInput({...taskInput, name: e.target.value})}
                                className="w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                                required
                            />
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <select
                                    value={taskInput.priority}
                                    onChange={(e) => setTaskInput({...taskInput, priority: e.target.value})}
                                    className="p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                                >
                                    <option value="A">∆Øu ti√™n A (R·∫•t quan tr·ªçng)</option>
                                    <option value="B">∆Øu ti√™n B (Quan tr·ªçng)</option>
                                    <option value="C">∆Øu ti√™n C (B√¨nh th∆∞·ªùng)</option>
                                </select>
                                <input
                                    type="date"
                                    value={taskInput.deadline}
                                    onChange={(e) => setTaskInput({...taskInput, deadline: e.target.value})}
                                    className="p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                                    required
                                />
                                <select
                                    value={taskInput.estimatedTime}
                                    onChange={(e) => setTaskInput({...taskInput, estimatedTime: e.target.value})}
                                    className="p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                                >
                                    <option value="30">30 ph√∫t</option>
                                    <option value="60">1 gi·ªù</option>
                                    <option value="90">1.5 gi·ªù</option>
                                    <option value="120">2 gi·ªù</option>
                                    <option value="180">3 gi·ªù</option>
                                </select>
                            </div>
                            <button
                                type="submit"
                                className="w-full p-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md"
                            >
                                {taskInput.id ? 'C·∫≠p Nh·∫≠t C√¥ng Vi·ªác' : 'Th√™m C√¥ng Vi·ªác'}
                            </button>
                        </form>
                    </div>
                )}

                {/* V√πng Th·ªëng k√™ & L·ªçc */}
                <div className="p-4 max-w-4xl mx-auto w-full">
                    <div className="flex justify-between items-center bg-white dark:bg-gray-800 p-3 rounded-xl shadow-md border-l-4 border-teal-500">
                        <div className="flex items-center text-teal-600 dark:text-teal-400">
                            <LucideIcon name="CheckCircle" size={20} className="mr-2" />
                            <span className="font-medium">T·ªïng th·ªùi gian ho√†n th√†nh:</span>
                        </div>
                        <span className="text-xl font-bold text-gray-900 dark:text-white">{formatTime(totalCompletedTime)}</span>
                    </div>

                    <div className="mt-4 flex space-x-2 text-sm">
                        {['active', 'completed', 'all'].map(f => (
                            <button
                                key={f}
                                onClick={() => setFilter(f)}
                                className={`px-4 py-2 rounded-full font-medium transition ${
                                    filter === f 
                                        ? 'bg-indigo-600 text-white shadow-lg' 
                                        : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'
                                }`}
                            >
                                {f === 'active' ? 'Vi·ªác C·∫ßn L√†m' : f === 'completed' ? 'ƒê√£ Ho√†n Th√†nh' : 'T·∫•t C·∫£'}
                            </button>
                        ))}
                    </div>
                </div>

                {/* V√πng Danh S√°ch C√¥ng Vi·ªác */}
                <main className="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 max-w-4xl mx-auto w-full pb-20">
                    {filteredAndSortedTasks.length > 0 ? (
                        filteredAndSortedTasks.map(task => (
                            <TaskCard key={task.id} task={task} />
                        ))
                    ) : (
                        <div className="p-10 text-center text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 rounded-xl shadow-md mt-6">
                            <LucideIcon name="Calendar" size={32} className="mx-auto mb-3 text-indigo-400" />
                            <p className="text-lg">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o trong danh s√°ch n√†y.</p>
                            <p className="text-sm">H√£y nh·∫•n n√∫t <LucideIcon name="Plus" size={14} className="inline-block" /> ƒë·ªÉ th√™m c√¥ng vi·ªác m·ªõi!</p>
                        </div>
                    )}
                </main>
                 <p className="text-center text-xs mt-2 text-gray-400 dark:text-gray-500 pb-4">
                    UserID t·∫°m th·ªùi: {userId} (D·ªØ li·ªáu s·∫Ω kh√¥ng b·ªÅn v·ªØng n·∫øu kh√¥ng c√≥ c·∫•u h√¨nh Firebase)
                </p>
            </div>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>

</body>
</html>